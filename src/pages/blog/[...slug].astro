---
import { Image } from 'astro:assets'
import { getCollection, render } from 'astro:content'

import Comments from 'components/react/comments/Comments'
import IndexTracker from 'components/astro/posts/IndexTracker/index.astro'
import ImageWithCaption from 'components/astro/design-system/ImageWithCaption/index.astro'
import ReactionButton from 'components/react/reactions/ReactionButton'
import RootLayout from 'layouts/RootLayout.astro'
import Tag from 'components/astro/design-system/Tag/index.astro'
import { formatDate } from 'utils/date'
import { getPosts } from 'utils/blog'
import type { BlogPost } from 'types/blog'

export const getStaticPaths = async () => {
  const posts = await getPosts()

  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }))
}

const postToFind = await getCollection('blog', (entry) => entry.id === Astro.params.slug)
const post = postToFind[0] as BlogPost

const { Content, remarkPluginFrontmatter } = await render(post)

const heroImagePath = post.data.hero.src.replace(/^.*\/public/, '').split('?')[0]

export const prerender = true
---

<RootLayout
  title={post.data.title}
  description={post.data.description}
  date={post.data.date}
  image={heroImagePath}
  class="grid grid-rows-[auto,1fr,auto]"
>
  <div class="relative grid gap-4 md:grid-cols-[210px,1fr]">
    <IndexTracker post={post} />
    <article class="adjust-heading-scroll grid w-full gap-4">
      <header class="grid">
        <h1 class="prose-h1">{post.data.title}</h1>
        <div class="grid gap-2 md:grid-cols-[max-content_1fr] md:gap-4">
          <p class="prose-body1 text-wrap text-object-low">
            {formatDate(post.data.date)} - {remarkPluginFrontmatter?.minutesRead}
          </p>
          <div class="flex space-x-2">
            {post.data.tags.map((tag) => <Tag>{tag}</Tag>)}
          </div>
        </div>
      </header>
      <ImageWithCaption
        src={post.data.hero}
        alt={post.data.heroAlt}
        caption={post.data.heroCredit}
      />
      <section class="prose w-full max-w-none text-object-high">
        <Content />
      </section>
    </article>
  </div>
  {
    post.data.discussionId && (
      <ReactionButton discussionId={post.data.discussionId} client:only="react" />
    )
  }
  {post.data.discussionId && <Comments discussionId={post.data.discussionId} client:only="react" />}
</RootLayout>
